# =============================================================================
# Docker Compose for iota_service
# =============================================================================
# Usage:
#   docker compose up -d          # start all services
#   docker compose logs -f app    # follow app logs
#   docker compose down            # stop all services
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    container_name: iota_service
    ports:
      - "${PORT:-4000}:4000"
    env_file: .env
    environment:
      # Required vars validated at compose-up time
      SECRET_KEY_BASE: "${SECRET_KEY_BASE:?Set SECRET_KEY_BASE in .env}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:?Set ADMIN_PASSWORD in .env}"
      # Docker-specific default: inside the container 127.0.0.1 ≠ the host
      IOTA_NODE_URL: "${IOTA_NODE_URL:-http://host.docker.internal:9000}"
    restart: unless-stopped
    depends_on:
      ttyd:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    # Add extra_hosts so host.docker.internal resolves on Linux
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ---------------------------------------------------------------------------
  # ttyd — Web-based terminal accessible from the User Portal
  # ---------------------------------------------------------------------------
  ttyd:
    image: tsl0922/ttyd:latest
    container_name: iota_ttyd
    command: >
      ttyd
        --writable
        --port 7681
        bash
    ports:
      - "${TTYD_PORT:-7681}:7681"
    restart: unless-stopped
