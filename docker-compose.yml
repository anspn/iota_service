# =============================================================================
# Docker Compose for iota_service
# =============================================================================
# Usage:
#   docker compose up -d          # start all services
#   docker compose logs -f app    # follow app logs
#   docker compose down            # stop all services
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iota_service
    env_file: .env
    volumes:
      # Shared session recording volume (app writes pending files, reads history)
      - session_data:/data/sessions
    environment:
      # Required vars validated at compose-up time
      SECRET_KEY_BASE: "${SECRET_KEY_BASE:?Set SECRET_KEY_BASE in .env}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:?Set ADMIN_PASSWORD in .env}"
      # Default: IOTA testnet (override with IOTA_NODE_URL in .env for local node)
      IOTA_NODE_URL: "${IOTA_NODE_URL:-https://api.testnet.iota.cafe}"
    ports:
      - "${PORT:-4000}:4000"
    restart: unless-stopped
    depends_on:
      ttyd:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # ttyd â€” Web-based terminal accessible from the User Portal
  # Commands are recorded to the shared session volume for notarization.
  # ---------------------------------------------------------------------------
  ttyd:
    image: tsl0922/ttyd:latest
    container_name: iota_ttyd
    # Create the pending directory with world-writable permissions so the
    # Elixir app (non-root "iota" user) can write pending session files.
    # Then launch ttyd with the session recording shell script.
    command: >
      sh -c '
        mkdir -p /data/sessions/pending &&
        chmod 777 /data/sessions /data/sessions/pending &&
        exec ttyd --writable --port 7681 /data/scripts/session_shell.sh'
    volumes:
      # Shared session recording volume (shell writes history, reads pending files)
      - session_data:/data/sessions
      # Bind-mount the session shell script (read-only)
      - ./priv/scripts:/data/scripts:ro
    environment:
      SESSIONS_DIR: /data/sessions
    ports:
      - "${TTYD_PORT:-7681}:7681"
    restart: unless-stopped

volumes:
  session_data:
